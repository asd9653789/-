<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>å¤§èª¿æŸ¥ç³»çµ±</title>
  <style>
    body { font-family: sans-serif; margin: 20px; background: #111; color: #eee; }
    input, textarea, button { font-size: 16px; padding: 6px; margin: 4px 0; }
    textarea { width: 100%; height: 60px; }
    .container { display: flex; gap: 40px; margin-top: 20px; }
    .list { width: 45%; }
    ul { list-style: none; padding: 0; }
    li { margin: 4px 0; }
    .clickable { color: #4ae; cursor: pointer; text-decoration: underline; }
    .delete-btn { color: red; margin-left: 10px; cursor: pointer; }
    .result { margin-top: 30px; }
    .card-grid { display: flex; flex-wrap: wrap; gap: 16px; margin-top: 10px; }
    .card { background: #1e1e1e; color: white; padding: 16px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.4); width: 220px; }
    .card h4 { margin-top: 0; font-size: 18px; border-bottom: 1px solid #555; padding-bottom: 5px; }
    .item-icon { width: 32px; height: 32px; vertical-align: middle; margin-right: 5px; }
    .monster-icon { width: 64px; height: 64px; vertical-align: middle; margin-right: 5px; }
    .card li { list-style: none; margin: 6px 0; }
  </style>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getDatabase, ref, set, get } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDA89wQdeacurqcrdFUs3PRNteUnT7GKS8",
      authDomain: "leeeo-91be5.firebaseapp.com",
      databaseURL: "https://leeeo-91be5-default-rtdb.firebaseio.com",
      projectId: "leeeo-91be5",
      storageBucket: "leeeo-91be5.appspot.com",
      messagingSenderId: "770145678642",
      appId: "1:770145678642:web:88f73a986123350911532b",
      measurementId: "G-NGCR9KRKHK"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    window.itemToMonsters = {};
    window.monsterToItems = {};
    window.editingItem = null;

    async function loadData() {
      const snapshot = await get(ref(db, '/'));
      const data = snapshot.val() || {};
      window.itemToMonsters = data.itemToMonsters || {};
      window.monsterToItems = data.monsterToItems || {};
      updateLists();
    }

    window.toggleList = function(id) {
      const ul = document.getElementById(id);
      const header = ul.previousElementSibling;
      if (ul.style.display === 'none') {
        ul.style.display = '';
        header.innerHTML = header.innerHTML.replace('â–¶', 'â–¼');
      } else {
        ul.style.display = 'none';
        header.innerHTML = header.innerHTML.replace('â–¼', 'â–¶');
      }
    };

    async function saveData() {
      await set(ref(db, '/'), {
        itemToMonsters: window.itemToMonsters,
        monsterToItems: window.monsterToItems
      });
    }

    window.addSingleEntry = async function () {
      const item = document.getElementById("itemSingleInput").value.trim();
      const monstersStr = document.getElementById("monstersForItemInput").value.trim();
      if (!item || !monstersStr) return;
      const monsters = monstersStr.split(/\s+/).map(m => m.trim());

      window.itemToMonsters[item] = monsters;
      monsters.forEach(monster => {
        if (!window.monsterToItems[monster]) window.monsterToItems[monster] = [];
        if (!window.monsterToItems[monster].includes(item)) {
          window.monsterToItems[monster].push(item);
        }
      });

      await saveData();
      updateLists();
      window.editingItem = null;
    };

    window.updateEntry = function () {
      if (!window.editingItem) return alert("è«‹å…ˆé¸æ“‡è¦ä¿®æ”¹çš„é“å…·");
      window.deleteItem(window.editingItem).then(() => {
        window.addSingleEntry();
      });
    };

    window.deleteItem = async function (item) {
      const monsters = window.itemToMonsters[item] || [];
      delete window.itemToMonsters[item];
      monsters.forEach(monster => {
        if (window.monsterToItems[monster]) {
          window.monsterToItems[monster] = window.monsterToItems[monster].filter(i => i !== item);
          if (window.monsterToItems[monster].length === 0) delete window.monsterToItems[monster];
        }
      });
      await saveData();
      updateLists();
    };

    window.deleteMonster = async function (monster) {
      const items = window.monsterToItems[monster] || [];
      delete window.monsterToItems[monster];
      items.forEach(item => {
        if (window.itemToMonsters[item]) {
          window.itemToMonsters[item] = window.itemToMonsters[item].filter(m => m !== monster);
          if (window.itemToMonsters[item].length === 0) delete window.itemToMonsters[item];
        }
      });
      await saveData();
      updateLists();
    };

    window.editItem = function (item) {
      const monsters = window.itemToMonsters[item];
      document.getElementById("itemSingleInput").value = item;
      document.getElementById("monstersForItemInput").value = monsters.join(" ");
      window.editingItem = item;
    };

    function updateLists() {
      const itemList = document.getElementById("itemList");
      const monsterList = document.getElementById("monsterList");
      itemList.innerHTML = '';
      monsterList.innerHTML = '';

      Object.keys(window.itemToMonsters).sort().forEach(item => {
        const li = document.createElement("li");
        li.innerHTML = `<span class="clickable" onclick="handleClick('${item}', 'item')">${item}</span>` +
                       `<span class='delete-btn' onclick="deleteItem('${item}')">[åˆªé™¤]</span>` +
                       `<span class='delete-btn' onclick="editItem('${item}')">[ä¿®æ”¹]</span>`;
        itemList.appendChild(li);
      });

      Object.keys(window.monsterToItems).sort().forEach(monster => {
        const li = document.createElement("li");
        li.innerHTML = `<span class="clickable" onclick="handleClick('${monster}', 'monster')">${monster}</span>` +
                       `<span class='delete-btn' onclick="deleteMonster('${monster}')">[åˆªé™¤]</span>`;
        monsterList.appendChild(li);
      });
    }

    function getItemImage(entry) {
      const match = entry.match(/\((\d+)\)$/);
      if (!match) return '';
      const id = match[1];
      return `<img class="item-icon" src="https://maplestory.io/api/GMS/64/item/${id}/icon" alt="item">`;
    }

    function getMonsterImage(entry) {
      const match = entry.match(/\((\d+)\)$/);
      if (!match) return '';
      const id = match[1];
      return `<img class="monster-icon" src="https://maplestory.io/api/GMS/64/mob/${id}/icon" alt="monster">`;
    }

    window.showResult = function (name, list, type) {
      const resultBox = document.getElementById("resultBox");
      const isItem = type === 'item';
      const label = isItem ? 'æ‰è½æ€ªç‰©' : 'æ‰è½é“å…·';
      resultBox.innerHTML = `<h3>ğŸ” ${label}ï¼š<span style="color:#0af">${name}</span></h3>`;

      const grid = document.createElement("div");
      grid.className = "card-grid";
      list.forEach(entry => {
        const card = document.createElement("div");
        card.className = "card";
        const h4 = document.createElement("h4");
        h4.className = "clickable";
        h4.innerHTML = `${isItem ? getMonsterImage(entry) : getItemImage(entry)}${entry}`;
        h4.addEventListener("click", () => handleClick(entry, isItem ? 'monster' : 'item'));
        card.appendChild(h4);

        const match = entry.match(/\((\d+)\)$/);
        if (match) {
          const subtitle = document.createElement("div");
          subtitle.textContent = `ID: ${match[1]}`;
          card.appendChild(subtitle);
        }

        grid.appendChild(card);
      });

      resultBox.appendChild(grid);
    };

    window.handleClick = function (name, type) {
      const list = type === 'item' ? window.itemToMonsters[name] : window.monsterToItems[name];
      if (list) {
        window.showResult(name, list, type);
      } else {
        document.getElementById("resultBox").innerHTML = `âŒ æŸ¥ç„¡è³‡æ–™ï¼š${name}`;
      }
    };

    
    window.filterList = function () {
      const keyword = document.getElementById("searchInput").value.trim();
      const itemList = document.getElementById("itemList");
      const monsterList = document.getElementById("monsterList");

      [...itemList.children].forEach(li => {
        li.style.display = li.innerText.includes(keyword) ? '' : 'none';
      });
      [...monsterList.children].forEach(li => {
        li.style.display = li.innerText.includes(keyword) ? '' : 'none';
      });
    };

    loadData();
  </script>
</head>
<body>
  <h1>å¤§èª¿æŸ¥ç³»çµ±</h1>
  <input type="text" id="searchInput" placeholder="ğŸ” æœå°‹é“å…·æˆ–æ€ªç‰©..." oninput="filterList()" />

  <h2>æ–°å¢æˆ–ä¿®æ”¹è³‡æ–™</h2>
  <p>é“å…·åç¨±ï¼ˆå«IDï¼‰ï¼š<button onclick="document.getElementById('itemSingleInput').value = ''">æ¸…é™¤</button></p>
  <textarea id="itemSingleInput" placeholder="é“å…·(é“å…·ä»£ç¢¼)"></textarea>
  <p>æ‰è½æ­¤é“å…·çš„æ€ªç‰©ï¼ˆç”¨ç©ºæ ¼åˆ†éš”ï¼‰ï¼š<button onclick="document.getElementById('monstersForItemInput').value = ''">æ¸…é™¤</button></p>
  <textarea id="monstersForItemInput" placeholder="æ€ªç‰©A(æ€ªç‰©Aä»£ç¢¼) æ€ªç‰©B(æ€ªç‰©Bä»£ç¢¼)"></textarea>
  <button onclick="addSingleEntry()">åŠ å…¥è³‡æ–™</button>
  <button onclick="updateEntry()">æ›´æ–°è³‡æ–™</button>

  <div class="container">
    <div class="list">
      <h3 onclick="toggleList('itemList')" style="cursor:pointer;">ğŸ“¦ é“å…·åˆ—è¡¨ â–¼</h3>
      <ul id="itemList"></ul>
    </div>
    <div class="list">
      <h3 onclick="toggleList('monsterList')" style="cursor:pointer;">ğŸ‘¾ æ€ªç‰©åˆ—è¡¨ â–¼</h3>
      <ul id="monsterList"></ul>
    </div>
  </div>

  <div class="result" id="resultBox">
    ğŸ” é»æ“Šé“å…·æˆ–æ€ªç‰©æŸ¥çœ‹ç›¸é—œè³‡æ–™
  </div>
</body>
</html>
